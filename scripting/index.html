<html>
  <head>
    <!-- leaflet -->
    <script src="https://unpkg.com/h3-js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  
    <!-- deck.gl standalone bundle -->
    <script src="https://unpkg.com/deck.gl@^8.8.0/dist.min.js"></script>
    <!-- deck.gl-leaflet -->
    <script src="https://unpkg.com/deck.gl-leaflet@1.1.1/dist/deck.gl-leaflet.min.js"></script>

    <style>
      #map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
  </body>

  <script type="text/javascript">

  const PARKING =
  //'https://geo-server.advanced-infrastructure.co.uk/geoserver/gwc/service/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&LAYER=oxford:oxford&STYLE=&TILEMATRIX=EPSG:900913:{z}&TILEMATRIXSET=EPSG:900913&FORMAT=application/vnd.mapbox-vector-tile&TILECOL={x}&TILEROW={y}';

  'https://geo-server.advanced-infrastructure.co.uk/geoserver/gwc/service/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&LAYER=oxford:groundmountpv&STYLE=&TILEMATRIX=EPSG:900913:{z}&TILEMATRIXSET=EPSG:900913&FORMAT=application/vnd.mapbox-vector-tile&TILECOL={x}&TILEROW={y}';

  const h3data = 'GroundmountPV_h3.csv'
  
  let url = h3data;
    const response = fetch(url).then(response => {
      const parsedh3data = response;      
    })


  const map = L.map(document.getElementById('map'), {
    center: [51.753, -1.245],
    zoom: 14,
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);

const deckLayer = new DeckGlLeaflet.LeafletLayer({
  views: [
    new deck.MapView({
      repeat: true
    })
  ],
  layers: [
    new deck.MVTLayer({
      id: 'mvt',
      data: PARKING,
      filled: true,
      // Styles                
      getSourcePosition: f => [-1.245184590946568, 51.75307306057298], // oxford
      getTargetPosition: f => f.geometry.coordinates,
      getLineColor: [192, 192, 192],
      //getFillColor: [50, 50, 255],
      getFillColor: f => {
        switch (f.properties.Agri_Grade) {
          case 'falsen Agricultural':
            return [200, 250, 55];
          case 'Grade 1':
            return [200, 220, 200];
          case 'Grade 2':
            return [230, 240, 230];
          case 'urban':
            return [230, 110, 20];  
          default:
            return [130, 110, 220];
        }
      },
      getWidth: 1,
      pickable: true,
      autoHighlight: true,
      onClick: info => info.object && alert(`${info.object.properties.Agri_Grade}`)
    }),
    new deck.H3HexagonLayer({
      id: 'h3-hexagon-layer',
      data: parsedh3data,
      pickable: true,
      wireframe: false,
      filled: true,
      //extruded: true,
      elevationScale: 20,
      getHexagon: d => d.hex,
      getFillColor: d => [255, (1 - d.count / 500) * 255, 0],
      //getElevation: d => d.count
    })
  ],
});

map.addLayer(deckLayer);

const featureGroup = L.featureGroup();
featureGroup.addLayer(L.marker([51.75307306057298, -1.245184590946568]));
map.addLayer(featureGroup);

  </script>
</html>
